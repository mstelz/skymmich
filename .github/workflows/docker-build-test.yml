name: Test Docker Build

on:
  pull_request:
    branches:
      - main
    paths:
      - 'Dockerfile'
      - 'docker-compose.yml'
      - '.dockerignore'
      - 'package*.json'
      - 'apps/**'
      - 'packages/**'
      - 'tools/**'
      - '.github/workflows/docker-build-test.yml'

permissions:
  contents: read
  pull-requests: write  # Required for commenting on PRs
  security-events: write  # For uploading SARIF files

jobs:
  test-build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run TypeScript type checking
        run: npm run check

      - name: Build application
        run: npm run build

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Lint Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
          ignore: DL3008,DL3009,DL3018  # DL3018: Pin versions in Alpine (not always practical)

      - name: Build Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64
          push: false
          tags: |
            astromich:test-${{ github.event.pull_request.number }}
            astromich:test-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true  # Load image for local testing

      - name: Test Docker image structure
        run: |
          echo "## Docker Image Test Results üß™" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Test if the image was built successfully
          if docker image inspect astromich:test-${{ github.event.pull_request.number }} > /dev/null 2>&1; then
            echo "‚úÖ **Image built successfully**" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Image build failed**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          # Check image size
          IMAGE_SIZE=$(docker image inspect astromich:test-${{ github.event.pull_request.number }} --format='{{.Size}}' | numfmt --to=iec-i --suffix=B)
          echo "üì¶ **Image size:** $IMAGE_SIZE" >> $GITHUB_STEP_SUMMARY
          
          # Test if required directories exist
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Directory Structure Check" >> $GITHUB_STEP_SUMMARY
          docker run --rm astromich:test-${{ github.event.pull_request.number }} ls -la /app/dist > /dev/null 2>&1 && echo "‚úÖ /app/dist exists" >> $GITHUB_STEP_SUMMARY || echo "‚ùå /app/dist missing" >> $GITHUB_STEP_SUMMARY
          docker run --rm astromich:test-${{ github.event.pull_request.number }} ls -la /app/config > /dev/null 2>&1 && echo "‚úÖ /app/config exists" >> $GITHUB_STEP_SUMMARY || echo "‚ùå /app/config missing" >> $GITHUB_STEP_SUMMARY
          docker run --rm astromich:test-${{ github.event.pull_request.number }} ls -la /app/logs > /dev/null 2>&1 && echo "‚úÖ /app/logs exists" >> $GITHUB_STEP_SUMMARY || echo "‚ùå /app/logs missing" >> $GITHUB_STEP_SUMMARY
          docker run --rm astromich:test-${{ github.event.pull_request.number }} ls -la /app/sidecars > /dev/null 2>&1 && echo "‚úÖ /app/sidecars exists" >> $GITHUB_STEP_SUMMARY || echo "‚ùå /app/sidecars missing" >> $GITHUB_STEP_SUMMARY
          
          # Check if startup script is executable
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Startup Script Check" >> $GITHUB_STEP_SUMMARY
          docker run --rm --entrypoint="" astromich:test-${{ github.event.pull_request.number }} test -x /app/startup.sh && echo "‚úÖ startup.sh is executable" >> $GITHUB_STEP_SUMMARY || echo "‚ùå startup.sh is not executable" >> $GITHUB_STEP_SUMMARY

      - name: Run container smoke test
        run: |
          # Start container with minimal config
          docker run -d \
            --name astromich-test \
            -p 5000:5000 \
            -e NODE_ENV=production \
            -e DATABASE_URL=postgresql://test:test@localhost:5432/test \
            astromich:test-${{ github.event.pull_request.number }}
          
          # Give it time to start (or fail)
          sleep 10
          
          # Check if container is still running
          if docker ps | grep -q astromich-test; then
            echo "‚úÖ Container started successfully" >> $GITHUB_STEP_SUMMARY
            docker logs astromich-test
          else
            echo "‚ùå Container failed to start" >> $GITHUB_STEP_SUMMARY
            docker logs astromich-test
            exit 1
          fi
          
          # Cleanup
          docker stop astromich-test || true
          docker rm astromich-test || true

      - name: Scan for vulnerabilities (SARIF)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: astromich:test-${{ github.event.pull_request.number }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'  # Fail on critical vulnerabilities

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()  # Upload even if scan found vulnerabilities
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'trivy-pr'

      - name: Generate vulnerability report
        uses: aquasecurity/trivy-action@master
        if: always()  # Generate report even if previous scan failed
        with:
          image-ref: astromich:test-${{ github.event.pull_request.number }}
          format: 'table'
          severity: 'CRITICAL,HIGH,MEDIUM'
          output: 'trivy-report.txt'
          exit-code: '0'  # Don't fail, just generate report

      - name: Export Docker image as artifact
        if: success() || failure()  # Export even if security scan failed
        run: |
          docker save astromich:test-${{ github.event.pull_request.number }} | gzip > astromich-pr-${{ github.event.pull_request.number }}-${{ github.sha }}.tar.gz

      - name: Upload Docker image artifact
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-pr-${{ github.event.pull_request.number }}
          path: astromich-pr-${{ github.event.pull_request.number }}-${{ github.sha }}.tar.gz
          retention-days: 7

      - name: Create application snapshot
        if: success() || failure()
        run: |
          mkdir -p snapshot
          tar -czf snapshot/astromich-snapshot-${{ github.sha }}.tar.gz \
            --exclude=node_modules \
            --exclude=.git \
            --exclude=snapshot \
            dist/

      - name: Upload application snapshot
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: app-snapshot-${{ github.sha }}
          path: snapshot/astromich-snapshot-${{ github.sha }}.tar.gz
          retention-days: 7

      - name: Comment PR with results
        uses: actions/github-script@v7
        if: always() && github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            let trivyReport = '';
            let statusIcon = '‚úÖ';
            let statusText = 'All checks passed!';
            
            // Check if the workflow failed
            if (context.job.status === 'failure') {
              statusIcon = '‚ùå';
              statusText = 'Build failed - see details below';
            }
            
            try {
              trivyReport = fs.readFileSync('trivy-report.txt', 'utf8');
              if (trivyReport.trim()) {
                // Check if critical vulnerabilities were found
                if (trivyReport.includes('CRITICAL')) {
                  statusIcon = '‚ùå';
                  statusText = 'Critical vulnerabilities found!';
                }
                trivyReport = '\n\n<details>\n<summary>Vulnerability Scan Results</summary>\n\n```\n' + trivyReport + '\n```\n</details>';
              } else {
                trivyReport = '\n\n‚úÖ **No vulnerabilities found!**';
              }
            } catch (e) {
              trivyReport = '\n\n‚ö†Ô∏è **Vulnerability scan report not available**';
            }
            
            const output = `#### Docker Build Test üê≥
            
            ${statusIcon} **${statusText}**
            
            - TypeScript compilation: ${{ steps.*.outcome[3] == 'success' && '‚úÖ' || '‚ùå' }}
            - Application build: ${{ steps.*.outcome[4] == 'success' && '‚úÖ' || '‚ùå' }}
            - Docker image build: ${{ steps.*.outcome[5] == 'success' && '‚úÖ' || '‚ùå' }}
            - Container smoke test: ${{ steps.*.outcome[7] == 'success' && '‚úÖ' || '‚ùå' }}
            - Security scan: ${{ steps.*.outcome[8] == 'success' && '‚úÖ Passed' || '‚ùå Failed' }}
            ${trivyReport}
            
            ### üì¶ Build Artifacts
            
            The following artifacts are available for download:
            - **Docker Image**: \`docker-image-pr-${{ github.event.pull_request.number }}\` (7 days retention)
            - **Application Snapshot**: \`app-snapshot-${{ github.sha }}\` (7 days retention)
            
            View the full test results and download artifacts from the [Actions summary](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            *Pushed by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })